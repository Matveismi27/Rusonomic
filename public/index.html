<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Русономик</title>
    <link rel="stylesheet" href="style.css">
    <script src="/socket.io/socket.io.js"></script>
</head>
<body>
    <canvas class="canvas" id="build_canvas" height="512" width="512"></canvas>
    <canvas class="canvas" id="fight_canvas" height="512" width="512"></canvas>
    <div class="high_menu market">
        <div class="product">
            <div class="name">Дерево</div>
            <div class="cost">1 з.</div>
            <div class="count">6 шт.</div>
        </div>
    </div>
    <div class="bottom_panel" id="big_back">
        <div class="button back" onclick="back()">назад</div>
    </div>
    <div class="bottom_panel" id="earn_panel">
        <div class="button back" onclick="back()">меню</div>
        <div class="button" id="earn_wood">добыть дерево</div>
        <div class="button" id="craft_statuet">создать статуэтку</div>
        <div class="button" id="to_forest">Выйти в лес</div>
    </div>
    <div class="bottom_panel" id="upgrade_panel">
        <div class="button back" onclick="back()">назад</div>
        <div class="button" id="read_books">Читать книги</div>
        <div class="button" id="find_master">Найти мастера</div>
        <div class="button" id="build_town">Строить город</div>
    </div>

    <div class="bottom_panel" id="main_panel">
        <div class="button" id="upgrade">Прокачка</div>
        <div class="button" id="earn">Добыча ресурсов</div>
        <div class="button" id="market">Рынок</div>
    </div>


    <div class="right_menu">
        <div class="town_info info">Статус города:</div>
        <div class="player_info info">Статус игрока:</div>
    </div>
</body>
<script src="build_minigame.js"></script>
<script src="fight_minigame.js"></script>
<script>
    const socket = io();
    socket.emit("get_data",(response)=>{
        data = response.data;
        display(data);
    })
    document.querySelector("#main_panel").style.display = "block";

    function back() {
        document.querySelector(".right_menu").style.display = "block";
        document.querySelector("#main_panel").style.display = "block";
        document.querySelector("#big_back").style.display = "none";
        document.querySelector("#upgrade_panel").style.display = "none";
        document.querySelector("#earn_panel").style.display = "none";   
        document.querySelector(".market").style.display = "none";
        document.querySelector("#build_canvas").style.display = "none";
        document.querySelector("#fight_canvas").style.display = "none";
    }
    function display_market(){
        //Открыть интерфейс рынка
        document.querySelector("#earn_panel").style.display = "none";
        document.querySelector("#main_panel").style.display = "none";
        document.querySelector("#big_back").style.display = "block";
        document.querySelector(".market").style.display = "grid";
        document.querySelector("#upgrade_panel").style.display = "none";
        document.querySelector(".right_menu").style.display = "none";
    }
    function display_upgrade(){
        //Открыть интерфейс прокачки
        document.querySelector("#earn_panel").style.display = "none";
        document.querySelector("#main_panel").style.display = "none";
        document.querySelector("#big_back").style.display = "none";
        document.querySelector("#upgrade_panel").style.display = "block";
    }
    function display_earn(){
        //Открыть интерфейс добычи
        document.querySelector("#earn_panel").style.display = "block";
        document.querySelector("#main_panel").style.display = "none";
        document.querySelector("#upgrade_panel").style.display = "none";
        document.querySelector("#big_back").style.display = "none";

    }
    function display_build(){
        document.querySelector("#upgrade_panel").style.display = "none";
        document.querySelector("#build_canvas").style.display = "block";
        document.querySelector("#big_back").style.display = "block";
    }
    function display_fight(){
        document.querySelector("#earn_panel").style.display = "none";
        document.querySelector("#fight_canvas").style.display = "block";
        document.querySelector("#big_back").style.display = "block";
    }
    document.querySelector("#market").addEventListener('click', (e) => {
        display_market()
    });
    document.querySelector("#upgrade").addEventListener('click', (e) => {
        display_upgrade()
    });
    document.querySelector("#earn").addEventListener('click', (e) => {
        display_earn()
    });
    document.querySelector("#build_town").addEventListener('click', (e) => {
        display_build()
    });
    document.querySelector("#to_forest").addEventListener('click', (e) => {
        display_fight()
        let fight_canvas = document.querySelector("#fight_canvas");
        fightGame(fight_canvas)
        let fightGame_ = new FightGame(fight_canvas);
        fightGame_.init();
        fightGame_.enemy("ork", 1, 1);
    });
    

    async function display(data){
        data.town.text = `
        <span>Имя города:</span> ${data.town.name} <br>
        <span>Казна города:</span> ${data.town.money}₽<br>
        <span>Население:</span> ${data.town.population}<br>
        `;
        player = data.players[socket.id];
        data.players[socket.id].text = `
        <span>id:</span> ${socket.id}<br>
        <span>Имя:</span> ${player.name}<br>
        <span>Капитал:</span> ${player.money}₽<br>
        <span>уровень:</span> ${player.level}<br>
        <span>класс:</span> ${player.class}<br>
        `;
        document.querySelector(".town_info").innerHTML = data.town.text
        document.querySelector(".player_info").innerHTML = data.players[socket.id].text
    }
    socket.on('data', (new_data) => {
        data = new_data;
        display(data);
    });

    document.querySelector("#earn_wood").addEventListener('click', (e) => {
        e.preventDefault();
        socket.emit('earn_wood',socket.id)
    });
    document.querySelector("#craft_statuet").addEventListener('click', (e) => {
        e.preventDefault();
        //Базовая проверка на наличие ресурсов, остальное сделает сервер
        socket.emit('craft_statuet',socket.id);
    });
    
    
let build_canvas = document.getElementById("build_canvas")
BuildTown(build_canvas)
</script>
</html>